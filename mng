#!/usr/bin/env -S v -raw-vsh-tmp-prefix tmp run

import os
import term

fn copy_html_docs() ! {
	html_source_dir := 'docs/html'
	static_dest_dir := 'site/static/reference'

	println('Copying HTML docs from ${html_source_dir} to ${static_dest_dir}')

	// Remove existing static reference directory if it exists
	if os.exists(static_dest_dir) {
		os.rmdir_all(static_dest_dir) or {} // Don't fail if directory doesn't exist
	}

	// Copy HTML documentation to static directory
	os.mkdir_all(static_dest_dir)!

	// Copy all files from HTML directory to static directory
	files := os.glob('${html_source_dir}/**') or { []string{} }
	for file in files {
		if os.is_file(file) {
			// Extract relative path by slicing the string after html_source_dir
			rel_start := html_source_dir.len + 1
			if file.len > rel_start {
				relative_path := file[rel_start..]
				if relative_path.len > 0 { // Make sure it's not empty
					dest_file := os.join_path(static_dest_dir, relative_path)

					// Create parent directory if needed
					parent_dir := os.dir(dest_file)
					os.mkdir_all(parent_dir)!

					println(' - Copying ${relative_path}')
					os.cp(file, dest_file)!
				}
			}
		}
	}

	println(term.ok_message('HTML documentation copied to static/reference!'))
}

// Get the command from arguments
mut cmd := 'help'
if os.args.len > 1 {
	cmd = os.args[1]
}

if cmd == 'docs' {
	// Generate documentation from source
	println(term.ok_message('Generating documentation...'))

	// Run doxygen to generate HTML and XML
	result := os.execute('doxygen Doxyfile')
	if result.exit_code != 0 {
		println(term.fail_message('Doxygen failed to run: ${result.output}'))
		return
	}

	println(term.ok_message('Documentation generated successfully!'))
	println(term.ok_message('Moving HTML documentation to static directory...'))

	copy_html_docs() or { println(term.fail_message('Error copying HTML docs: ${err}')) }

	println(term.ok_message('Documentation integrated into Svelte site!'))
} else if cmd == 'help' {
	println('Gama Documentation Generator')
	println('Usage: mng build|docs')
	println('  build/docs - Generate Doxygen documentation and integrate into Svelte site')
	println('  help       - Show this help message')
} else {
	println(term.fail_message('Unknown command: ${cmd}'))
	println('Run "mng help" for available commands')
}
