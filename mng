#!/usr/bin/env -S v -raw-vsh-tmp-prefix tmp run

import term
import os

fn copy_html_docs() ! {
	html_source_dir := 'docs/html'
	static_dest_dir := 'site/static/reference'

	println('Copying HTML docs from ${html_source_dir} to ${static_dest_dir}')

	// Remove existing static reference directory if it exists
	if exists(static_dest_dir) {
		rmdir_all(static_dest_dir) or {} // Don't fail if directory doesn't exist
	}

	// Copy HTML documentation to static directory
	mkdir_all(static_dest_dir)!

	// Copy all files from HTML directory to static directory
	files := glob('${html_source_dir}/**') or { []string{} }
	for file in files {
		if is_file(file) {
			// Extract relative path by slicing the string after html_source_dir
			rel_start := html_source_dir.len + 1
			if file.len > rel_start {
				relative_path := file[rel_start..]
				if relative_path.len > 0 { // Make sure it's not empty
					dest_file := join_path(static_dest_dir, relative_path)

					// Create parent directory if needed
					parent_dir := dir(dest_file)
					mkdir_all(parent_dir)!

					println(' - Copying ${relative_path}')
					cp(file, dest_file)!
				}
			}
		}
	}

	println(term.ok_message('HTML documentation copied to static/reference!'))
}

fn build() {
	println('Building gama for linux')
	mut result := execute('v -os linux cli.v -o bin/gama')
	if result.exit_code != 0 {
		println(term.fail_message('host build failed: ${result.output}'))
		return
	}
	println('Building gama for windows')
	result = execute('v -os windows cli.v -o bin/gama')
	if result.exit_code != 0 {
		println(term.fail_message('windows build failed: ${result.output}'))
		return
	}
}

fn package() {
	println('Packaging with nsis')
	result := execute('makensis nsis/setup.nsi')
	if result.exit_code != 0 {
		println(term.fail_message('makensis failed: ${result.output}'))
		return
	}
	println('Packaging deb with nfpm')
	result := execute('nfpm package -f nfpm/nfpm.yaml -p deb -t bin/')
	if result.exit_code != 0 {
		println(term.fail_message(result.output))
		return

	}
}

fn help() {
	println('Gama Documentation Generator')
	println('Usage: mng build|docs')
	println('  build/docs - Generate Doxygen documentation and integrate into Svelte site')
	println('  help       - Show this help message')
}

fn docs() {
	// Generate documentation from source
	println(term.ok_message('Generating documentation...'))

	// Run doxygen to generate HTML and XML
	result := execute('doxygen Doxyfile')
	if result.exit_code != 0 {
		println(term.fail_message('Doxygen failed to run: ${result.output}'))
		return
	}

	println(term.ok_message('Documentation generated successfully!'))
	println(term.ok_message('Moving HTML documentation to static directory...'))

	copy_html_docs() or { println(term.fail_message('Error copying HTML docs: ${err}')) }

	println(term.ok_message('Documentation integrated into Svelte site!'))
}


// Get the command from arguments
mut cmd := 'help'
if os.args.len > 1 {
	cmd = os.args[1]
}

if cmd == 'docs' {
	docs()
} else if cmd == 'help' {
	help()
} else if cmd == 'build' {
	build()
} else if cmd == 'package' {
	build()
	vgama()
	package()
} else {
	println(term.fail_message('Unknown command: ${cmd}'))
	help()
}
